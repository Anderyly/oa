<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>苏北评估智地规划办公系统</title>
    <link href="/static/css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="/static/css/font-awesome.min.css?v=4.4.0" rel="stylesheet">
    <link href="/static/css/animate.css" rel="stylesheet">
    <!--<link href="/static/layui/css/layui.css" rel="stylesheet">-->
    <link href="/static/css/plugins/iCheck/custom.css" rel="stylesheet">
    <link href="/static/css/plugins/chosen/chosen.css" rel="stylesheet">
    <link href="/static/css/plugins/switchery/switchery.css" rel="stylesheet">
    <link href="/static/css/style.min.css?v=4.1.0" rel="stylesheet">
    <link href="/static/elementUI/css/index.min.css" rel="stylesheet">
    <script src="/static/elementUI/js/vue.min.js"></script>
    <script src="/static/elementUI/js/index.min.js"></script>
    <script src="/static/laydate/laydate.js"></script>
    <link href="/static/select2/css/select2.css" rel="stylesheet" />
    <link rel="stylesheet" href="/static/layui/css/layui.css">
    <link rel="stylesheet" type="text/css" href="/static/webupload/webuploader.css">
    <link rel="stylesheet" type="text/css" href="/static/webupload/style.css">
    <style type="text/css">
        .long-tr th {
            text-align: center
        }

        .long-td td {
            text-align: center
        }

        /*elementUI分页样式*/
        .layout-pagination {
            text-align: right;
            margin-top: 15px;
        }

        .control-label {
            margin-top: 7px;
            text-align: right;
        }

        .li {
            display: inline-block;
            font-size: 14px;
            padding: 10px;
            border: 1px solid #e7eaec;
        }

        .a {
            text-decoration: none;
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0);
            -webkit-user-select: none;
            -moz-user-focus: none;
            -moz-user-select: none;
            color: black;
        }

        .a:hover {
            color: black;
        }

        .act {
            border-bottom: 3px solid #0064c8;
        }

        .xxx {
            padding-top: 50px
        }

        .h3downline {
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 15px;
            font-weight: bold;
            color: black;
        }
    </style>
</head>
<body class="gray-bg">
<div class="wrapper wrapper-content animated fadeInRight" id="app">

    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">

                <div class="ibox-content row" style="margin-left: 1px;margin-right: 1px;">
                    <div class="col-sm-4">
                        <h3 class="h3downline">报告信息</h3>
                        <form @submit.prevent="submit">
                            <div class="form-group">
                                <label>报告类型</label>
                                <select id="type" name="type" class="form-control" required="required"
                                        v-model="res.report_type" @change="changeReportType">
                                    <option :value="item.id" v-for="(item, index) in report_type_arr"
                                            :key="index">{{item.text}}</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="">报告编号</label>
                                <input class="form-control" v-model="res.report_text" id="report_text">
                            </div>
                            <div class="form-group">
                                <label class="">估价基准日期</label>
                                <input class="form-control laydate" v-model="res.benchmark_date"
                                       id="benchmark_date">
                            </div>
                            <div class="form-group">
                                <label class="">项目名称</label>
                                <input name="" class="form-control" v-model="res.name">
                            </div>

                            <div class="form-group">
                                <label class="">指定报告人：</label>
                                <div class="">
                                    <select id="report_uid" name="report_uid"
                                            class="form-control selectpicker show-tick form-control select2 select2-drop-mas"
                                            title="请选择">
                                        <option></option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="">操作人：</label>
                                <input class="form-control" v-model="res.nickname || user.nickname"
                                       disabled="disabled">
                            </div>
                            <div class="form-group">
                                <label class="">创建时间：</label>
                                <input type="text" name="created_at" class="form-control" disabled="disabled"
                                       v-model="res.created_at">
                            </div>

                            <input type="submit" class="btn btn-primary" value="确定修改"
                                   :disabled="res.status == 5">
                            <input :disabled="res.status != 4" type="submit" class="btn btn-warning"
                                   value="确定结案" @click="close">

                        </form>
                    </div>

                    <div class="col-sm-4">
                        <h3 class="h3downline">作报告</h3>
                        <div>

                            <div class="form-group">
                                <label class="">委托单位</label>
                                <input class="form-control" v-model="res.entrusted_unit" required>
                            </div>
                            <div class="form-group">
                                <label class="">报告名称</label>
                                <input class="form-control" v-model="res.report_name" required>
                            </div>
                            <div class="form-group">
                                <label class="">土地面积</label>
                                <input class="form-control" v-model="res.land_size" required>
                            </div>
                            <div class="form-group">
                                <label class="">建筑面积</label>
                                <input class="form-control" v-model="res.floor_size" required>
                            </div>
                            <div class="form-group">
                                <label class="">估价目的</label>
                                <textarea class="form-control" v-model="res.evaluation_aim" required></textarea>
                            </div>
                            <div class="form-group">
                                <label class="">估价时间</label>
                                <input class="form-control laydate" v-model="res.evaluation_date"
                                       id="evaluation_date" required>
                            </div>
                            <div class="form-group">
                                <label class="">设定用途</label>
                                <input class="form-control" v-model="res.purpose" required>
                            </div>
                            <div class="form-group">
                                <label class="">使用银行</label>
                                <input class="form-control" v-model="res.bank" required>
                            </div>
                            <div class="form-group">
                                <label class="">房地产总价</label>
                                <input class="form-control" v-model="res.total_amount" required>
                            </div>

                            <!-- <div class="form-group" style="position:relative">
                                <label class="control-label">客户信息</label><br>
                                <button type="button" data-toggle="modal" data-target="#myModal"
                                    class="btn btn-success">客户信息</button>
                            </div> -->

                            <div class="form-group" style="margin-bottom:5px;">
                                <label class="control-label">客户信息</label>

                                <div id="cpdiv">
                                    <div id="tmd1000000" v-if="show">
                                        <a title="移除条目">
                                            <i class="fa fa-times" @click="delp(1000000)"></i>
                                        </a>
                                        <input type="text" class="form-control" name="kh_company[]"
                                               style="display:inline-block;width:25%;" placeholder="公司名称" >
                                        <input type="text" class="form-control" name="kh_name[]"
                                               style="display:inline-block;width:30%;" placeholder="联系人">
                                        <input type="text" class="form-control" name="kh_phone[]"
                                               style="display:inline-block;width:30%;" placeholder="联系电话">
                                        <a title="添加客户">
                                            <i class="fa fa-plus-square-o" onclick="addp()"></i>
                                        </a>
                                    </div>

                                    <div :id="'tmd10000' + index" v-for="(item,index) in res.customer">
                                        <a title="移除条目">
                                            <i class="fa fa-times" @click="delp('10000' + index)"></i>
                                        </a>
                                        <input type="text" class="form-control" name="kh_company[]"
                                               style="display:inline-block;width:25%;" placeholder="公司名称" :value="item.kh_company">
                                        <input type="text" class="form-control" name="kh_name[]"
                                               style="display:inline-block;width:30%;" placeholder="联系人" :value="item.kh_name">
                                        <input type="text" class="form-control" name="kh_phone[]"
                                               style="display:inline-block;width:30%;" placeholder="联系电话" :value="item.kh_phone">
                                        <a title="添加客户">
                                            <i class="fa fa-plus-square-o" onclick="addp()"></i>
                                        </a>
                                    </div>

                                </div>
                            </div>

                            <div class="form-group">
                                <label class=" control-label">选择参与人员：</label>
                                <div class="">
                                    <div id="partake_uid" class="demo-transfer"></div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="">附件：</label>
                                <div class="">
                                    <div id="imgPicker">选择文件</div>
                                </div>
                                <table id="datatable" class="table-bordered  table table-hover">
                                    <tbody>
                                    <tr>
                                        <th>附件名称</th>
                                        <th width="60">大小</th>
                                        <th width="60">操作</th>
                                    </tr>
                                    <tr v-for="(item,index) in res.enclosure_file_data"
                                        :id="'report' + item.id">
                                        <td><a :href="item.url" target="_blank">{{item.name}}</a></td>
                                        <td>{{item.size}} kb</td>
                                        <td><button oncilck=""
                                                    class="btn btnDelete btn-danger btn-xs">删除</button></td>
                                        </td>
                                    </tr>
                                    </tbody>

                                </table>
                            </div>

                            <div class="form-group">
                                <label class="">报告：</label>
                                <div class="">
                                    <div id="imgPicker1">选择文件</div>
                                </div>
                                <table id="datatable1" class="table-bordered  table table-hover">
                                    <tbody>
                                    <tr>
                                        <th>报告名称</th>
                                        <th width="60">大小</th>
                                        <th width="60">操作</th>
                                    </tr>
                                    <tr v-for="(item,index) in res.report_file_data"
                                        :id="'report' + item.id">
                                        <td><a :href="item.url" target="_blank">{{item.name}}</a></td>
                                        <td>{{item.size}} kb</td>
                                        <td><button oncilck=""
                                                    class="btn btnDelete btn-danger btn-xs">删除</button></td>
                                        </td>
                                    </tr>
                                    </tbody>

                                </table>
                            </div>



                            <div class="form-group">
                                <label class="">作报告人：</label>
                                <input class="form-control" v-model="res.nickname || user.nickname"
                                       disabled="disabled">
                            </div>
                            <div class="form-group">
                                <label class="">创建时间：</label>
                                <input type="text" id="created_at" name="created_at" class="form-control"
                                       disabled="disabled" value="">
                            </div>

                            <input type="submit" class="btn btn-warning" value="存为草稿" @click="report(1)"
                                   :disabled="res.status != 0 && res.status != 1">
                            <input type="submit" class="btn btn-primary" value="提交审核" @click="report(2)"
                                   :disabled="res.status != 0 && res.status != 1">

                        </div>
                    </div>

                    <div class="col-sm-4">
                        <h3 class="h3downline">审核报告</h3>
                        <div>
                            <div class="form-group">
                                <label>备注：</label>
                                <textarea id="meta" name="meta" class="form-control" type="text"
                                          v-model="verify_content" cols="5" rows="4" style="resize: none;"
                                          :disabled="res.status != 2"></textarea>
                            </div>
                            <div class="col-md-12">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="control-label">报告费用</label>
                                        <input class="form-control" v-model="report_amount" type="text"
                                               @change="reportAmount">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="control-label">报告质量</label>
                                        <select class="validate[required]" v-model="report_quality"
                                                style="width: 100%;" @change="reportAmount" id="report_quality">
                                            <option :value="item.id" :base="item.base"
                                                    v-for="(item,index) in reportData">
                                                {{item.text}}({{item.base}})
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="control-label">最终报告费用</label>
                                        <input class="form-control" type="text" v-model="report_final_amount">
                                    </div>
                                </div>
                            </div>
                            <!-- report_amount:"",
                            report_final_amount:"",
                            report_quality:", -->

                            <div class="form-group">
                                <label>操作人：</label>
                                <input id="nickname" class="form-control" type="text" disabled="disabled"
                                       :value="user.nickname">
                            </div>

                            <div class="form-group">
                                <label>批准时间：</label>
                                <input type="text" id="created_at1" name="created_at" class="form-control"
                                       disabled="disabled">
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary" type="submit" :disabled="res.status != 2"
                                        @click="verify(1)">
                                    通过</button>
                                <button class="btn btn-danger" type="submit" :disabled="res.status != 2"
                                        @click="verify(2)">
                                    拒绝</button>
                            </div>
                            <table id="datatable4" class="table-bordered  table table-hover">
                                <tbody>
                                <tr>
                                    <th style="width: 90px;">审核人</th>
                                    <th style="width: 160px;">审核时间</th>
                                    <th style="width:80px">状态</th>
                                    <!-- <th></th> -->
                                </tr>
                                <tr v-for="(item,index) in res.verify">
                                    <td style="90px">{{item.nickname}}</td>
                                    <td style="width: 160px;">{{item.examine_date}}</td>
                                    <td v-if="item.examine_type == 1"><span
                                            class="label label-table label-success">通过</span></td>
                                    <td v-if="item.examine_type != 1"><span
                                            class="label label-table label-danger">拒绝</span></td>
                                    <!-- <td>
                                        <a class="btn btn-primary waves-effect waves-light btn-xs checkResult"
                                            href="javascript:;" rel="79858">详情
                                            <div class="hid" style="display:none"></div>
                                        </a>
                                    </td> -->
                                </tr>

                                </tbody>
                            </table>
                        </div>
                        <div v-if="res.status >= 3">
                            <h3 class="h3downline" style="padding-top:60px">报告盖章</h3>
                            <div>

                                <div class="form-group">
                                    <label>备注：</label>
                                    <textarea id="meta" name="meta" class="form-control" type="text"
                                              v-model="seal_content" cols="5" rows="4" style="resize: none;"
                                              :disabled="res.status != 3"></textarea>
                                </div>
                                <div class="col-md-12">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="control-label">审核质量</label>
                                            <select class="selectpicker" id="seal_quality"
                                                    v-model="seal_quality" @change="sealAmount">
                                                <option :value="item.id" :base="item.base"
                                                        v-for="(item,index) in sealData">{{item.name}}
                                                    ({{item.base}})</option>
                                            </select>

                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="control-label">最终审核费用</label>
                                            <input class="form-control input-sm" v-model="seal_final_amount"
                                                   type="text">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>操作人：</label>
                                    <input id="nickname" class="form-control" type="text" disabled="disabled"
                                           :value="user.nickname">
                                </div>

                                <div class="form-group">
                                    <label>批准时间：</label>
                                    <input type="text" id="created_at2" name="created_at" class="form-control"
                                           disabled="disabled">
                                </div>

                                <div class="form-group">
                                    <button class="btn btn-primary" type="submit" :disabled="res.status != 3"
                                            @click="seal(1)"> 通过</button>
                                    <button class="btn btn-danger" type="submit" :disabled="res.status != 3"
                                            @click="seal(2)"> 拒绝</button>
                                </div>
                                <table id="datatable8" class="table-bordered  table table-hover">
                                    <tbody>
                                    <tr>
                                        <th style="width: 90px;">审核人</th>
                                        <th style="width: 160px;">审核时间</th>
                                        <th style="width:80px">状态</th>
                                        <!-- <th></th> -->
                                    </tr>
                                    <tr v-for="(item,index) in res.seal">
                                        <td style="width:90px">{{item.nickname}}</td>
                                        <td style="width:160px">{{item.examine_date}}</td>
                                        <td v-if="item.examine_type == 1"><span
                                                class="label label-table label-success">通过</span></td>
                                        <td v-if="item.examine_type != 1"><span
                                                class="label label-table label-danger">拒绝</span></td>
                                        <!-- <td>
                                            <a class="btn btn-primary waves-effect waves-light btn-xs checkResult"
                                                href="javascript:;" rel="79858">详情
                                                <div class="hid" style="display:none"></div>
                                            </a>
                                        </td> -->
                                    </tr>

                                    </tbody>
                                </table>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<script src="/static/js/jquery.min.js?v=2.1.4"></script>
<script src="/static/js/bootstrap.min.js?v=3.3.6"></script>
<script src="/static/js/content.min.js?v=1.0.0"></script>
<script src="/static/js/plugins/chosen/chosen.jquery.js"></script>
<script src="/static/js/plugins/iCheck/icheck.min.js"></script>
<!-- <script src="/static/js/plugins/layer/laydate/laydate.js"></script> -->
<script src="/static/js/plugins/switchery/switchery.js"></script>
<script src="/static/layui/layui.js"></script>
<!--IOS开关样式-->
<script src="/static/js/jquery.form.js"></script>
<script src="/static/js/moment.min.js"></script>
<!-- <script src="/static/js/layer/layer.js"></script> -->
<script src="/static/js/laypage/laypage.js"></script>
<script src="/static/js/laytpl/laytpl.js"></script>
<script src="/static/js/lunhui.js"></script>
<script src="/js/globe.js"></script>
<script src="/static/select2/js/select2.js"></script>
<script type="text/javascript" src="/static/webupload/webuploader.min.js"></script>

<script>

    let pid = 1;


    function addp() {
        var html = '<div id="tmd' + pid + '" style="margin-top:5px"><a title="移除条目"><i class="fa fa-times" onclick="delp(' +
            pid +
            ')"></i></a>' +
            '&nbsp;<input type="text" class="form-control" name="kh_company[]" style="display:inline-block;width:25%;" placeholder="公司名称">&nbsp;' +
            '<input type="text" class="form-control" name="kh_name[]" style="display:inline-block;width:30%;" placeholder="联系人">&nbsp;' +
            '<input type="text" class="form-control" name="kh_phone[]" style="display:inline-block;width:30%;" placeholder="联系电话" value="">' +
            '&nbsp;<a title="添加客户"><i class="fa fa-plus-square-o" onclick="addp()"></i></a><br></div>';
        pid = pid + 1;
        $("#cpdiv").append(html);
    }

    function delp(d) {
        $("#tmd" + d).remove();
    }

    $(document).ready(function() {
        $(".i-checks").iCheck({
            checkboxClass: "icheckbox_square-green",
            radioClass: "iradio_square-green",
        });
        var myDate = new Date;
        var year = myDate.getFullYear(); //获取当前年
        var mon = myDate.getMonth() + 1; //获取当前月
        var date = myDate.getDate(); //获取当前日
        var h = myDate.getHours(); //获取当前小时数(0-23)
        var m = myDate.getMinutes(); //获取当前分钟数(0-59)
        var s = myDate.getSeconds(); //获取当前秒
        var value = year + "-" + mon + "-" + date + " " + h + ":" + m + ":" + s;
        console.log(value)
        $("#created_at").val(value)
        $("#created_at1").val(value)
        $("#created_at2").val(value)
    });
</script>


<script type="text/javascript">
    var vm = new Vue({
        el: '#app',
        data: {
            user: "",
            res: {},
            report_type_arr: [],
            verify_content: "",
            report_amount: "",
            report_final_amount: "",
            report_quality: "",
            reportData: {},
            report_index: "",
            sealData: [],
            seal_final_amount: "",
            seal_quality: "",
            seal_content: "",
            enclosure_file: [],
            report_file: [],
            customer: {
                company_name: "",
                user_name: "",
                phone: ""
            },
            show:false,
            showModal: false
        },

        methods: {
            reportAmount(event) {
                let base = $("#report_quality option:checked").attr("base")
                console.log(base)
                this.report_final_amount = this.report_amount * base
            },
            sealAmount(event) {
                let base = $("#seal_quality option:checked").attr("base")
                console.log(base)
                this.seal_final_amount = this.res.report_final_amount * base
            },
            changeReportType(e) {
                let data = httpCurl("ReportType/text", {
                    id: e.target.value
                })
                this.res.report_text = data.data.text
            },
            submit() {
                let postData = {
                    id: this.res.id,
                    report_uid: $("#report_uid option:checked").val(),
                    report_type: this.res.report_type,
                    report_text: this.res.report_text,
                    benchmark_date: this.res.benchmark_date,
                    name: this.res.name,

                }
                let data = httpCurl("report/edit", postData)
                if (data.code == 200) {
                    layer.msg(data.msg, {
                        icon: 6,
                        time: 2000
                    }, function() {
                        location.reload()
                    });
                } else {
                    layer.msg(data.msg, {
                        icon: 5,
                        time: 2000
                    });
                }
            },
            report(status) {
                let kh_name = [];
                let kh_phone = [];
                let kh_company = [];
                let kh = [];
                $('input[name^="kh_company[]"]').each(function(index,element){
                    //压入数组
                    kh_company[index] = $(this).val();
                });
                $('input[name^="kh_name[]"]').each(function(index,element){
                    //压入数组
                    kh_name[index] = $(this).val();
                });
                $('input[name^="kh_phone[]"]').each(function(index,element){
                    //压入数组
                    kh_phone[index] = $(this).val();
                });

                for(let i = 0; i <= kh_name.length; i++) {
                    if (kh_company[i] == undefined || kh_company[i] == "") {
                        continue
                    }
                    let arr = {
                        kh_company: kh_company[i],
                        kh_name: kh_name[i],
                        kh_phone: kh_phone[i],
                    }
                    kh.push(arr)
                }

                let postData = {
                    id: this.res.id,
                    entrusted_unit: this.res.entrusted_unit,
                    report_name: this.res.report_name,
                    land_size: this.res.land_size,
                    floor_size: this.res.floor_size,
                    evaluation_aim: this.res.evaluation_aim,
                    evaluation_date: this.res.evaluation_date,
                    purpose: this.res.purpose,
                    bank: this.res.bank,
                    total_amount: this.res.total_amount,
                    enclosure_file: this.res.enclosure_file,
                    report_file: this.res.report_file,
                    partake_uid: this.res.partake_uid,
                    customer: JSON.stringify(kh),
                    status: status,
                    enclosure_file: this.enclosure_file.toString(),
                    report_file: this.report_file.toString()
                }
                let data = httpCurl("report/edit", postData)
                if (data.code == 200) {
                    layer.msg(data.msg, {
                        icon: 6,
                        time: 2000
                    }, function() {
                        location.reload()
                    });
                } else {
                    layer.msg(data.msg, {
                        icon: 5,
                        time: 2000
                    });
                }
            },
            verify(status) {
                let postData = {
                    id: this.res.id,
                    status: status,
                    content: this.verify_content,
                    report_amount: this.report_amount,
                    report_final_amount: this.report_final_amount,
                    report_quality: this.report_quality
                }

                let data = httpCurl("report/verify", postData)
                if (data.code == 200) {
                    layer.msg(data.msg, {
                        icon: 6,
                        time: 2000
                    }, function() {
                        location.reload()
                    });
                } else {
                    layer.msg(data.msg, {
                        icon: 5,
                        time: 2000
                    });
                }
            },
            close() {
                let postData = {
                    id: this.res.id,
                }
                let data = httpCurl("report/close", postData)
                if (data.code == 200) {
                    layer.msg(data.msg, {
                        icon: 6,
                        time: 2000
                    }, function() {
                        location.reload()
                    });
                } else {
                    layer.msg(data.msg, {
                        icon: 5,
                        time: 2000
                    });
                }
            },

            seal(status) {
                let postData = {
                    id: this.res.id,
                    status: status,
                    content: this.seal_content,
                    seal_final_amount: this.seal_final_amount,
                    seal_quality: this.seal_quality
                }

                let data = httpCurl("report/seal", postData)
                if (data.code == 200) {
                    layer.msg(data.msg, {
                        icon: 6,
                        time: 2000
                    }, function() {
                        location.reload()
                    });
                } else {
                    layer.msg(data.msg, {
                        icon: 5,
                        time: 2000
                    });
                }
            }

        },
        mounted() {
            let user = sessionStorage.getItem("user");
            user = JSON.parse(user);
            this.user = user;
            this.res.uid = user.uid;

            let data = httpCurl("ReportType/getAll", {});
            this.report_type_arr = data.data.info

            let data1 = httpCurl("report/detail", {
                id: getUrlKey("id")
            });

            this.res = data1.data

            this.report_file = this.res.report_file.split(",")
            this.enclosure_file = this.res.enclosure_file.split(",")

            let reportA = httpCurl("ReportVerify/getAll", {});
            this.reportData = reportA.data.info

            let seal = httpCurl("ReportVerify/getAll", {});
            this.sealData = seal.data.info

            if (this.res.customer == null || this.res.customer[0] == null) {
                this.show = true
            }


        }
    });

    laydate.render({
        elem: '#benchmark_date',
        type: 'datetime',
        format: 'yyyy-MM-dd HH:mm:ss',
        done: function(value, date) {
            // $("end_time").val(value)
            vm.$data.res.benchmark_date = value
        }
    });

    laydate.render({
        elem: '#evaluation_date',
        type: 'datetime',
        format: 'yyyy-MM-dd HH:mm:ss',
        done: function(value, date) {
            // $("end_time").val(value)
            vm.$data.res.evaluation_date = value
        }
    });

    let data = httpCurl("user/getAll", {})
    $("#report_uid").select2({
        data: data.data.info,
        minimumInputLength: 0,
        placeholder: "可以模糊搜索", //默认值
        allowClear: true,
    });
    $('#report_uid').val([vm.$data.res.report_uid]).trigger('change');



    let partake_uid = vm.$data.res.partake_uid
    // if (!isNaN(partake_uid)) {
    // 	partake_uid = ""
    // }

    layui.use(['transfer', 'layer', 'util'], function() {
        var $ = layui.$,
            transfer = layui.transfer,
            layer = layui.layer,
            util = layui.util;

        console.log(partake_uid);
        let data = httpCurl("FinanceWages/getAllUser", {})
        //模拟数据
        var data1 = data.data.info
        //基础效果
        transfer.render({
            elem: '#partake_uid',
            data: data1,
            title: [
                [],
                []
            ],
            value: partake_uid.split(","),
            width: 120,
            height: 300,
            showSearch: true,
            onchange: function(data, index) {
                console.log(index)
                console.log(data)
                if (index == 0) {
                    var ttt = "";
                    for (var i = 0; i <= data.length - 1; i++) {
                        ttt += data[i]["value"] + ","
                    }

                    ttt = ttt.slice(0, ttt.length - 1)
                } else {
                    var arr = vm.$data.res.partake_uid.split(",");
                    var ttt = "";
                    for (var i = 0; i <= data.length - 1; i++) {
                        ttt += data[i]["value"] + ","
                        var local = $.inArray(data[i]["value"], arr); //根据元素值查找下标，不存在返回-1
                        arr.splice(local, 1);
                    }

                    ttt = arr.toString();
                }


                vm.$data.res.partake_uid = ttt;
            }
        })

    });

    $("#datatable").on('click', '.btnDelete', function() {
        let val = $(this).closest('tr')[0]['id'];
        val = val.replace('file', '');
        var local = $.inArray(val, vm.$data.enclosure_file); //根据元素值查找下标，不存在返回-1
        vm.$data.enclosure_file.splice(local, 1);
        $(this).closest('tr').remove();

    });

    var $list = $('#fileList');
    //上传图片,初始化WebUploader
    var uploader = WebUploader.create({

        auto: true, // 选完文件后，是否自动上传。
        swf: '/static/webupload/Uploader.swf', // swf文件路径
        server: sessionStorage.getItem("url") + "user/upload", // 文件接收服务端。
        duplicate: true, // 重复上传图片，true为可重复false为不可重复
        pick: '#imgPicker', // 选择文件的按钮。可选。
        formData: {
            token: sessionStorage.getItem("token"),
            ctype: 1,
            cid: vm.$data.res.id
        },

        // accept: {
        // 	title: 'Images',
        // 	extensions: 'gif,jpg,jpeg,bmp,png',
        // 	mimeTypes: 'image/jpg,image/jpeg,image/png'
        // },

        'onUploadSuccess': function(file, data, response) {

            if (data.code == 200) {
                html = '<tr id="file' + data.data.id + '"><td><a href="' + data.data.url +
                    '" target="_blank">' + data.data.name + '</a></td>' +
                    '<td>' + data.data.size + 'kb</td><td>' +
                    '<button oncilck="delid(file' + data.data.id +
                    ')" class="btn btnDelete btn-danger btn-xs">删除</button></td></tr>';
                $("#datatable").append(html)
                vm.$data.enclosure_file.push(data.data.id);
                layer.msg("上传成功", {
                    icon: 6,
                    time: 1500,
                    shade: 0.1
                }, function(index) {

                    layer.close(index);
                });

            } else {
                layer.msg(data.msg, {
                    icon: 5,
                    time: 1500,
                    shade: 0.1
                }, function(index) {
                    layer.close(index);
                });
            }
        }
    });

    uploader.on('fileQueued', function(file) {
        layer.msg("正在上传...", {
            icon: 6,
            time: 2000,
        });
    });

    //文件上传成功
    // uploader.on('uploadSuccess', function(file) {
    // 	$('#' + file.id).find('p.state').text('上传成功！');
    // });

    // 文件上传失败，显示上传出错。
    uploader.on('uploadError', function(file) {
        layer.msg("上传错误", {
            icon: 5,
            time: 2000,
        });
    });

    $("#datatable1").on('click', '.btnDelete', function() {
        let val = $(this).closest('tr')[0]['id'];
        val = val.replace('report', '');
        var local = $.inArray(val, vm.$data.report_file); //根据元素值查找下标，不存在返回-1
        vm.$data.report_file.splice(local, 1);
        $(this).closest('tr').remove();

    });

    var $list = $('#fileList');
    //上传图片,初始化WebUploader
    var uploader = WebUploader.create({

        auto: true, // 选完文件后，是否自动上传。
        swf: '/static/webupload/Uploader.swf', // swf文件路径
        server: sessionStorage.getItem("url") + "user/upload", // 文件接收服务端。
        duplicate: true, // 重复上传图片，true为可重复false为不可重复
        pick: '#imgPicker1', // 选择文件的按钮。可选。
        formData: {
            token: sessionStorage.getItem("token"),
            ctype: 1,
            cid: vm.$data.res.id
        },

        // accept: {
        // 	title: 'Images',
        // 	extensions: 'gif,jpg,jpeg,bmp,png',
        // 	mimeTypes: 'image/jpg,image/jpeg,image/png'
        // },

        'onUploadSuccess': function(file, data, response) {

            if (data.code == 200) {
                html = '<tr id="report' + data.data.id + '"><td><a href="' + data.data.url +
                    '" target="_blank">' + data.data.name + '</a></td>' +
                    '<td>' + data.data.size + 'kb</td><td>' +
                    '<button oncilck="delid(report' + data.data.id +
                    ')" class="btn btnDelete btn-danger btn-xs">删除</button></td></tr>';
                $("#datatable1").append(html)
                vm.$data.report_file.push(data.data.id);
                layer.msg("上传成功", {
                    icon: 6,
                    time: 1500,
                    shade: 0.1
                }, function(index) {

                    layer.close(index);
                });

            } else {
                layer.msg(data.msg, {
                    icon: 5,
                    time: 1500,
                    shade: 0.1
                }, function(index) {
                    layer.close(index);
                });
            }
        }
    });

    uploader.on('fileQueued', function(file) {
        layer.msg("正在上传...", {
            icon: 6,
            time: 2000,
        });
    });

    //文件上传成功
    // uploader.on('uploadSuccess', function(file) {
    // 	$('#' + file.id).find('p.state').text('上传成功！');
    // });

    // 文件上传失败，显示上传出错。
    uploader.on('uploadError', function(file) {
        layer.msg("上传错误", {
            icon: 5,
            time: 2000,
        });
    });

</script>
</body>
</html>
